<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>內城社區體驗預約系統</title>
  <style>
    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background-color: #eef2f6;
      margin: 0;
      padding: 20px;
      color: #2c3e50;
    }
    h1 {
      text-align: center;
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 40px;
      letter-spacing: 2px;
    }
    .card {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      max-width: 720px;
      margin-left: auto;
      margin-right: auto;
    }
    .card h2 {
      font-size: 20px;
      border-left: 4px solid #3498db;
      padding-left: 10px;
      margin-bottom: 16px;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-bottom: 18px;
      font-weight: 500;
      font-size: 15px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"] {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 14px;
      transition: border 0.3s ease, box-shadow 0.3s ease;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus {
      border-color: #3498db;
      box-shadow: 0 0 4px rgba(52, 152, 219, 0.3);
      outline: none;
    }
    input[type="radio"],
    input[type="checkbox"] {
      margin-right: 6px;
      transform: scale(1.2);
    }
    fieldset {
      border: none;
      padding: 0;
      margin-bottom: 15px;
    }
    button {
      background-color: #3498db;
      color: white;
      padding: 14px 28px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      display: block;
      margin: 40px auto 20px auto;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
      box-shadow: 0 4px 12px rgba(41, 128, 185, 0.3);
    }
    .hidden {
      display: none;
    }
    #timeslots label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.6;
    }
    #error-message {
      color: red;
      text-align: center;
      font-size: 15px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>內城社區體驗預約系統</h1>

  <div class="card">
    <label>訂購人姓名：<input type="text" id="name" required></label>
    <label>訂購人電話：<input type="text" id="phone" required></label>
    <label>預約日期：
      <input type="date" id="date" required onchange="updateDataKey()">
    </label>

    <fieldset>
      <legend><strong>預約項目</strong></legend>
      <label><input type="checkbox" value="牛車" onchange="toggleSections()"> 鐵牛車</label>
      <label><input type="checkbox" value="割稻飯" onchange="toggleSections()"> 割稻飯</label>
      <label><input type="checkbox" value="粿DIY" onchange="toggleSections()"> 紅龜粿/草仔粿 DIY</label>
    </fieldset>
  </div>

  <div class="card hidden" id="section-niuche">
    <h2>鐵牛車預約</h2>
    <label>牛車數量（每台限乘6人）：
      <input type="number" id="niuche-count" min="1" onchange="checkTimeslots()">
    </label>

    <fieldset>
      <legend>選擇時段：</legend>
      <div id="timeslots"></div>
    </fieldset>
  </div>

  <div class="card hidden" id="section-rice">
    <h2>割稻飯預約</h2>
    <label>體驗人數：
      <input type="number" id="rice-count" min="1">
    </label>
    <label>預約時間：
      <input type="time" id="rice-time">
    </label>
  </div>

  <div class="card hidden" id="section-diy">
    <h2>紅龜粿 / 草仔粿 DIY</h2>
    <label>體驗人數：
      <input type="number" id="diy-count" min="1">
    </label>
    <label>預約時間：
      <input type="time" id="diy-time">
    </label>
  </div>

  <button onclick="submitForm()">送出表單</button>
  <div id="error-message"></div>

  <script>
    const arr = {};
    let DATA = "00000000";
    let N = 0;

    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const minDate = `${yyyy}-${mm}-${dd}`;
      document.getElementById("date").setAttribute("min", minDate);
    });

    function updateDataKey() {
      const dateInput = document.getElementById("date");
      const selectedDate = new Date(dateInput.value);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (selectedDate < today) {
        alert("請選擇今天以後的日期！");
        dateInput.value = "";
        return;
      }

      DATA = dateInput.value.replaceAll("-", "");
      if (!arr[DATA]) {
        arr[DATA] = [0, 30, 30, 30, 30];
      }
      checkTimeslots();
    }

    function toggleSections() {
      const checkboxes = document.querySelectorAll('input[type=checkbox]');
      document.getElementById("section-niuche").classList.add("hidden");
      document.getElementById("section-rice").classList.add("hidden");
      document.getElementById("section-diy").classList.add("hidden");

      checkboxes.forEach(box => {
        if (box.checked) {
          if (box.value === "牛車") document.getElementById("section-niuche").classList.remove("hidden");
          if (box.value === "割稻飯") document.getElementById("section-rice").classList.remove("hidden");
          if (box.value === "粿DIY") document.getElementById("section-diy").classList.remove("hidden");
        }
      });
    }

    function checkTimeslots() {
      const count = parseInt(document.getElementById("niuche-count").value) || 0;
      N = count;
      if (!arr[DATA]) return;

      const slots = [" 08:30~10:30", " 10:30~12:30", " 13:00~15:00", " 15:00~17:00"];
      const container = document.getElementById("timeslots");
      container.innerHTML = "";

      for (let i = 1; i <= 4; i++) {
        const remain = arr[DATA][i];
        const disabled = remain < N ? "disabled" : "";
        container.innerHTML += `
          <label>
            <input type="radio" name="niuche-time" value="${i}" ${disabled}>
            時段${i} ${slots[i - 1]}（剩餘牛車數：${remain}）
          </label><br>`;
      }
    }

    function submitForm() {
      document.getElementById("error-message").textContent = ""; // 清空錯誤訊息
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const date = document.getElementById("date").value;

      if (!name || !phone || !date) {
        document.getElementById("error-message").textContent = "請填寫姓名、電話與日期！";
        return;
      }

      if (!/^09\d{8}$/.test(phone)) {
        document.getElementById("error-message").textContent = "請輸入有效的台灣手機號碼（如：0912345678）";
        return;
      }

      const formData = { name, phone, date };

      if (!document.getElementById("section-niuche").classList.contains("hidden")) {
        const niucheCount = parseInt(document.getElementById("niuche-count").value);
        const timeChoice = document.querySelector('input[name="niuche-time"]:checked');
        if (!niucheCount || !timeChoice) {
          document.getElementById("error-message").textContent = "請完整填寫牛車預約！";
          return;
        }
        const slot = parseInt(timeChoice.value);
        if (arr[DATA][slot] < niucheCount) {
          document.getElementById("error-message").textContent = "牛車數量不足！";
          return;
        }
        formData.niucheCount = niucheCount;
        formData.niucheSlot = slot;
      }

      if (!document.getElementById("section-rice").classList.contains("hidden")) {
        const riceCount = document.getElementById("rice-count").value;
        const riceTime = document.getElementById("rice-time").value;
        if (!riceCount || !riceTime) {
          document.getElementById("error-message").textContent = "請填寫割稻飯人數與時間！";
          return;
        }
        formData.riceCount = riceCount;
        formData.riceTime = riceTime;
      }

      if (!document.getElementById("section-diy").classList.contains("hidden")) {
        const diyCount = document.getElementById("diy-count").value;
        const diyTime = document.getElementById("diy-time").value;
        if (!diyCount || !diyTime) {
          document.getElementById("error-message").textContent = "請填寫 DIY 人數與時間！";
          return;
        }
        formData.diyCount = diyCount;
        formData.diyTime = diyTime;
      }

      fetch("https://script.google.com/macros/s/AKfycbx_z3PTVhjrJqVtcHBdLsjyYUZt6BZB7EJRW3_U_6YfONtFJrxwMuxnrYiuCSA6ByfN8A/exec", {
        method: "POST",
        body: JSON.stringify(formData),
        headers: {
          "Content-Type": "application/json",
        }
      })
      .then(res => {
        if (!res.ok) {
          throw new Error("伺服器回應錯誤：" + res.status + " " + res.statusText);
        }
        return res.json();
      })
      .then(response => {
        if (response.success) {
          if (formData.niucheCount && formData.niucheSlot) {
            arr[DATA][formData.niucheSlot] -= formData.niucheCount;
          }
          alert("預約成功！資料已儲存");
          checkTimeslots();
          resetForm();
        } else {
          throw new Error(response.error || "未知錯誤");
        }
      })
      .catch(error => {
        document.getElementById("error-message").textContent = "提交失敗！原因：" + error.message;
        console.error("提交錯誤詳細內容：", error);
      });
    }

    function resetForm() {
      document.getElementById("name").value = "";
      document.getElementById("phone").value = "";
      document.getElementById("date").value = "";
      document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      toggleSections();
      document.getElementById("timeslots").innerHTML = "";
      document.getElementById("error-message").textContent = "";
    }
  </script>
</body>
</html>
